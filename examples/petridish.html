<html>
<script src="../dist/cacatoo.js"></script>                 <!-- Include cacatoo library (compiled with rollup) -->
<script src="../lib/all.js"></script>                      <!-- Include other libraries (concattenated in 1 file) -->
<link rel="stylesheet" href="../style/cacatoo.css">        <!-- Set style sheet -->

<script>
    /*-----------------------Start user-defined code ---------------------*/
    
    let sim;
    var mutationrate = 0.001;
    var death_rate_growing = 0.5;
    var mutations_required = 1;
    var growth_rate_wm = 1.0;

    function cacatoo()
    {
    
        let config = {
                title: "Mutational rescue on plate vs. well-mixed",
                description: "",
                maxtime: 10000000,
                fastmode: false,             // If possible, fast-mode will update the sim with more than 60 FPS. 
                                            // Note: fastmode is only useful/recommended if the sim can readily run 
                                            // at 60FPS without fast-mode, and may actually reduce the reported FPS
                                            // Nevertheless, the final state of the grid is reaches sooner in real time. 
                ncol : 400,            
                nrow : 400,		            // dimensions of the grid to build
                wrap : [false, false],       // Wrap boundary [COLS, ROWS]   
                scale : 1,				    // scale of the grid (nxn pixels per grid cell)
                graph_interval: 10,
                graph_update: 20,
                statecolours: {alive:'default'}   // The background state '0' is never drawn
        }
    
        sim = new Simulation(config)
    
        sim.makeGridmodel("cells"); 
        sim.createDisplay("cells","alive")    
        sim.makeGridmodel("cells_wellmixed"); 
        sim.createDisplay("cells_wellmixed","alive")    
        
        sim.cells.statecolours.alive[0] = [255,255,255] // Change bg to white
        sim.cells.statecolours.alive[1] = [79,31,154] // Change WT 1 to white
        sim.cells.statecolours.alive[2] = [228,178,36] // Change mutant 1 to gold
        sim.cells.statecolours.alive[3] = [32, 100, 100] // Change mutant 2 to dark-turquoise
        sim.cells.statecolours.alive[3] = [100, 100, 255] // Change mutant 3 to light blue        
        
        sim.cells.nextState = function(i,j)       // Define the next-state function. This example is stochastic growth in a petri dish
        {   
            let growthrate = this.name == "cells_wellmixed" ? growth_rate_wm : 1.0
            if(this.grid[i][j].alive == 0)
            {                   
                let neighbour = this.randomMoore8(this,i,j)              // In the Moore8 neighbourhood of this grid count # of 1's for the 'alive' property        
                if (neighbour.alive > 0 && sim.rng.genrand_real1() < growthrate)                        
                {
                    this.grid[i][j].alive = neighbour.alive
                    this.grid[i][j].age = 0
                    if(sim.rng.genrand_real1() < mutationrate)
                    {
                        this.grid[i][j].alive = this.grid[i][j].alive+1
                        if(this.grid[i][j].alive>18) this.grid[i][j].alive=2
                    }
                }
            } 
            else
            {
                if(this.grid[i][j].age < 2 && this.grid[i][j].alive <= mutations_required && sim.rng.genrand_real1() < death_rate_growing)
                    this.grid[i][j].alive = 0
                else 
                    this.grid[i][j].age++
            }
        }
    
        sim.cells_wellmixed.nextState = sim.cells.nextState // Nextstate is identical
            
        sim.cells.update = function()
        {
            this.asynchronous()         // Applied as many times as it can in 1/60th of a second
            this.plotPopsizes('alive',[1,2,3,4,5]) 
        }
    
        sim.cells_wellmixed.update = function()
        {
            this.asynchronous()         // Applied as many times as it can in 1/60th of a second
            this.plotPopsizes('alive',[1,2,3,4,5]) 
            sim.cells_wellmixed.perfectMix()
        }
    
        sim.cells.reset = function()
        {
            sim.initialSpot(sim.cells,'alive',1,1,sim.cells.nr/2,sim.cells.nc/2)
            sim.initialSpot(sim.cells_wellmixed,'alive',1,1,sim.cells_wellmixed.nr/2,sim.cells_wellmixed.nc/2)        
            sim.initialGrid(sim.cells,'age',0,1.0)
            sim.initialGrid(sim.cells_wellmixed,'age',0,1.0)
        } 
    
        sim.cells.reset()
    
        sim.cells.bottleneck = function()
        {
            for(let i=0; i<this.nc; i++)       
                for(let j=0;j<this.nr;j++)
                {
                    if(this.rng.genrand_real1() < 0.999) this.grid[i][j].alive = 0
                    if(sim.cells_wellmixed.rng.genrand_real1() < 0.999) sim.cells_wellmixed.grid[i][j].alive = 0
                }
            sim.cells_wellmixed.perfectMix()
            this.perfectMix()
        } 
        
        sim.addButton("Pause/Continue",function() {sim.toggle_play()})              // Add a button that calls function "display" in "model"
        sim.addButton("Mix plate once",function() { sim.cells.perfectMix()})            // Add a button that calls function "perfectMix" in "model.cheater"    
        sim.addButton("Keep plate mixed",function() { sim.toggle_mix()})                    // Add a button that calls function "perfectMix" in "model.cheater"  
        sim.addButton("Bottleneck (99.9%)",function() { sim.cells.bottleneck()})                    // Add a button that calls function "perfectMix" in "model.cheater"  
        sim.addButton("Reset simulation",function() { sim.cells.reset()})                    // Add a button that calls function "perfectMix" in "model.cheater"  
        sim.addHTML("form_holder","<br>")
        sim.addSlider("mutationrate",0.0,0.1,0.0001,"Mutation rate")
        sim.addSlider("death_rate_growing",0.0,1.0,0.01,"Death rate growing cells (wildtype)")
        sim.addSlider("growth_rate_wm",0.01,1.00,0.01,"Relative well-mixed growth rate")
        
        sim.addSlider("mutations_required",0,10,1,"Nr. of mutations required for escape")
      
        sim.start()
    }
    
    
    /*-------------------------End user-defined code ---------------------*/
    
    </script>
    
    <body onload="cacatoo()">        
        <div class="header" id="header"><h2>ModelJS - </h2></div>
        <div class="content" id="canvas_holder"></div>
        <div class="content" id="form_holder"></div>    
        <div class="content" id="graph_holder"><br><br><b><h3>Mutant population sizes (note: only first 5 mutations plotted)</h3></b> </div>
        <div class="footer" id="footer"></div>
    </body>
    </html>