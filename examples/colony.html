<!-- 
  ###########################################################################################
    Example (empty) project
  ###########################################################################################
-->

<html>
    <script src="../../dist/cacatoo.js"></script>                 <!-- Include cacatoo library (compiled with rollup) -->
    <script src="../../lib/all.js"></script>                      <!-- Include other libraries (concattenated in 1 file) -->

    <link rel="stylesheet" href="../../style/cacatoo.css">        <!-- Set style sheet -->

    <head>
        <title>Cacatoo</title>
    </head>


<script>

/*-----------------------Start user-defined code ---------------------*/

let sim; // Declare a variable named "sim" globally, so that we can access our cacatoo-simulation from wherever we need. 

/**
* function cacatoo() contains all the user-defined parts of a cacatoo-model. Configuration, update rules, what is displayed or plotted, etc. It's all here.
*/
function cacatoo()
{
    /*
        1. SETUP. First, set up a configuration-object. Here we define how large the grid is, how long will it run, what colours will the critters be, etc. 
    */
    let config = 
        {                                        
                title: "Colony",                 // The name of your cacatoo-simulation
                description: "",         // And a description if you wish
                maxtime: 1000000,                             // How many time steps the model continues to run            
                ncol : 100,                                   // Number of columns (width of your grid)
                nrow : 100,		                              // Number of rows (height of your grid)
                seed:5,
                wrap : [false, false],                         // Wrapped boundary conditions? [COLS, ROWS]   
                scale : 3,				                      // Scale of the grid (nxn pixels per grid point)
                statecolours: {'alive':{1:[245,245,150]}},          // Colours for each state. Background (0) defaults to black. 
        }

    /*
        1. SETUP. (continued) Now, let's use that configuration-object to generate a new Cacatoo simulation
    */
    sim = new Simulation(config)                          // Initialise the Cacatoo simulation
    sim.makeGridmodel("model")                              // Build a new Gridmodel within the simulation called "gol" (Game Of Life)
    sim.initialSpot(sim.model,'alive',1,1,sim.model.nr/2,sim.model.nc/2)    
    sim.createDisplay("model","alive","Living cells")                      // Create a display so we can see our newly made gridmodel
    
    sim.createDisplay("model","external_resources","External resources")                      // Create a display so we can see our newly made gridmodel
    sim.model.colourViridis("external_resources", 1000)

    sim.createDisplay("model","internal_resources","Internal resources")                      // Create a display so we can see our newly made gridmodel
    sim.model.colourViridis("internal_resources", 1000)
    
    /*
        2. DEFINING THE RULES. Below, the user defines the nextState function. This function will be applied for each grid point when we will update the grid later. 
    */

    // Define ODEs with basic resource dynamics
    let resource_dynamics = function(u,k) { return function(x, y) {
        return [
            -u*y[0],                 // y[0] is the external resource concentration, which is taken up with rate u
            u*y[0] - k*y[1]          // y[1] is the internal resource concentration, which is used by the cells to divide
        ]}}
        
    // Configuration object with initial states, parameters, and diffusion rates
    let ode_config = { ode_name: "resources",
                       init_states: [1,0],              // y[0] and y[1]
                       parameters: [0.0,0.1],           // u and k are set to 0.0 by default, as we will make it dependent on cell presence!
                       diffusion_rates: [0.2,0.0] }      // resources diffuse through exteral environment, but internal resources stay put
    
    // Attaches an ODE to all gridpoints with initial state = [0,0].    
    sim.model.attachODE(resource_dynamics,ode_config);

    sim.model.nextState = function(i,j)                   
    {   
        let randomneigh = this.randomMoore8(this,i,j)   // Random neighbour
        
        if(this.grid[i][j].alive == 0)                        // If empty
        {
            if(randomneigh.alive == 1 && this.rng.genrand_real1() < randomneigh.resources.state[1])
            {
                this.grid[i][j].alive = 1                     // 1 (cell) reproduces          

                randomneigh.resources.state[1] = sim.model.grid[i][j].resources.state[1] = randomneigh.resources.state[1]/4

            }
        }
        else
        {            
            sim.model.grid[i][j].resources.pars = [1.0,0.5]
        }
        
        this.grid[i][j].resources.solve_timestep(0.1) 
        
        this.grid[i][j].external_resources = Math.floor(this.grid[i][j].resources.state[0]*1000)
        this.grid[i][j].internal_resources = Math.floor(this.grid[i][j].resources.state[1]*800)
    }

    /*
        3. MAIN SIMULATION LOOP. Finally, we need to set the update-function, which is the mainwill be applied to the whole grid each time step. For now, all we will do is call "synchronous", which
        applies the next-state function shown above to each grid point. All cells are updated at the same time, rather than in turn (for this, use the function "asynchonous")
    */
    sim.model.update = function()
    {                                
        this.asynchronous()         // Applied as many times as it can in 1/60th of a second
        this.diffuseOdeStates()       // Diffusion of external metabolites
        this.plotODEstates("resources",[0,1],[[0,0,0],[255,0,0]])
    }

    /*
        OPTIONAL: Now that we have everything setup, we can also add some interactive elements (buttons or sliders). See cheater.html for more examples of this. 
    */
   
    sim.addButton("Play/pause sim",function() {sim.toggle_play()})

   
    sim.start()

}


/*-------------------------End user-defined code ---------------------*/

</script>

<body onload="cacatoo()">        
    <div class="header" id="header">        
        <h2>Cacatoo (example project)</h2>        
    </div>
      
    <div class="content" id="canvas_holder">    </div>
    <div class="content" id="graph_holder"> </div>
    <div class="content" id="form_holder"></div>

    <div class="content" id="examples">      
        This is an empty project.<br> Start from here if you want to build your own Cacatoo models. <br>For inspiration, take a look at <a href="index.html">these examples</a>. 
    </div>
    <div class="footer" id="footer"></div>

    </div>
</body>

</html>